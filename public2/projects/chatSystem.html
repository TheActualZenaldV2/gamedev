<!DOCTYPE html>
<html>
<head>
    <title>Multi-User Chat System</title>
</head>
<body onload="">

    <div id="user-container">
        <form id="user-from">
        <input type="text" id="username-input" placeholder="Enter your username..." required>
        <button type="submit" onclick="event.preventDefault(); submitUser();">Submit</button>
        </form>

    </div>
    <div id="chat-container" style="display: none;">
        <div id="message-container"></div>
        <form id="message-form">
            <div id="message-input-container">
            <input type="text" id="message-input" placeholder="Type your message here...">
<input type="file" id="file-input" accept="image/gif,image/webp,image/jpeg,image/png,image/apng">            <button type="submit" id="submitMessage">Send</button>

            </div>

            
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-storage.js"></script>
</body>

<style>
    /* import poppins font */

/* Set global styles */
body {
    background-color: #dddddd;
  font-family: "Poppins", sans-serif;
  margin: 0;
  padding: 0;
}

/* Set styles for message container */
#message-container, #user-container {
  background-color: #dddddd;
  border-radius: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  margin: 20px auto;
  max-width: 750px;
  padding: 20px;
}
#chat-container {
    max-height: 800px;
  background-color: #dddddd;
  border-radius: 5px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  margin: 20px auto;
  max-width: 800px;
  padding: 20px;
  overflow: scroll;
}

/* Set styles for messages */
.message {
  background-color: #bdb3b3;
  border-radius: 5px;
  font-size: 16px;
  margin-bottom: 10px;
  padding: 10px;
  display: flex;
  align-items: center;
}

/* Set styles for usernames */
.user {
  font-weight: bold;
  margin-right: 10px;
  flex-shrink: 0;
}
/* style input field */
#message-input {
  border: none;
  border-radius: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  font-size: 16px;
  padding: 10px;
  margin-right: 20px;
  width: calc(90% - 20px);
  bottom: 0;
  left: 0;
}
img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 10px 0;
  border-radius: 5px;
  box-shadow: 0 0 0 rgba(0, 0, 0, 0);
  transition: box-shadow 0.3s ease;
}

img:hover {
  box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
  transition: box-shadow 0.3s ease;
}
#chat-container::-webkit-scrollbar {
  width: 0;
  height: 0;
  background-color: transparent;
}
/* Style submit button and file input button */
#submit-button,
#file-input {
  display: inline-block;
  vertical-align: middle;
}

/* Add some space between the buttons */
#submit-button {
  margin-left: 10px;
}

/* Style the message input container */
#message-input-container {
  display: flex;
  align-items: center;
}
#message-input:disabled {
  background-color: #cccccc;
  cursor: default;
  cursor: not-allowed;
}
/* Style the submit button */
button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 10px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 13px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
button:disabled {
  background-color: #cccccc;
  cursor: default;
}
button:disabled:hover {
  background-color: #cccccc;
  cursor: not-allowed;
}

/* Change the background color of the button on hover */
button:hover {
  background-color: #3e8e41;
}

strong {
  font-weight: bold;
  padding-right: 5px;
}


@-webkit-keyframes swing-in-top-fwd {
  0% {
    -webkit-transform: rotateX(-100deg);
            transform: rotateX(-100deg);
    -webkit-transform-origin: top;
            transform-origin: top;
    opacity: 0;
  }
  100% {
    -webkit-transform: rotateX(0deg);
            transform: rotateX(0deg);
    -webkit-transform-origin: top;
            transform-origin: top;
    opacity: 1;
  }
}
@keyframes swing-in-top-fwd {
  0% {
    -webkit-transform: rotateX(-100deg);
            transform: rotateX(-100deg);
    -webkit-transform-origin: top;
            transform-origin: top;
    opacity: 0;
  }
  100% {
    -webkit-transform: rotateX(0deg);
            transform: rotateX(0deg);
    -webkit-transform-origin: top;
            transform-origin: top;
    opacity: 1;
  }
}
.message {
    -webkit-animation: swing-in-top-fwd 0.5s cubic-bezier(0.175, 0.885, 0.320, 1.275) both;
	        animation: swing-in-top-fwd 0.5s cubic-bezier(0.175, 0.885, 0.320, 1.275) both;
}

.hide   { display: none; }
</style>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyDXF0wkenM6F7AM29X-PupSj6JrJPwbDuM",
  authDomain: "multi-chat-86d3a.firebaseapp.com",
  databaseURL: "https://multi-chat-86d3a-default-rtdb.firebaseio.com",
  projectId: "multi-chat-86d3a",
  storageBucket: "multi-chat-86d3a.appspot.com",
  messagingSenderId: "619644574166",
  appId: "1:619644574166:web:d26a2cbaccabc38be7ec77",
  measurementId: "G-W8196MM2KN"
};
firebase.initializeApp(firebaseConfig);
console.log("Ignore Errors Please and Thank You");
// Get a reference to the database service
var database = firebase.database();
messageCount = 0;


// Get a reference to the message container
var messageContainer = document.getElementById("message-container");

// Get a reference to the message form, input, and username input
var messageForm = document.getElementById("message-form");
var messageInput = document.getElementById("message-input");
var usernameInput = document.getElementById("username-input");
var chatContainer = document.getElementById("chat-container");
var messageContainer = document.getElementById("message-container");
var fileInput = document.getElementById("file-input");

//send connection info to database
var connectionsRef = database.ref("/connections");
//on page load, send true
var connectedRef = database.ref(".info/connected");
connectedRef.on("value", function(snap) {
  if (snap.val()) {
    var con = connectionsRef.push(true);
    con.onDisconnect().remove();
  }
});
window.addEventListener("beforeunload", function() {
  //delete message from database
    database.ref("messages/" + messageElement.id).remove();
});
// Listen for new messages in the database
database.ref("messages").on("child_added", function(snapshot) {
    // Increment the message count
    messageCount++;

    // If there are more than 20 messages, delete the oldest message
    if (messageCount > 20) {
        var oldestMessage = messageContainer.firstChild;
        if (oldestMessage && oldestMessage.parentNode === messageContainer) {
            database.ref("messages/" + oldestMessage.id).remove();
            messageContainer.removeChild(oldestMessage);
            messageCount--;
        }
    }

    // Get the message data from the snapshot
    var message = snapshot.val();

    // Create a new message element
    var messageElement = document.createElement("div");
    messageElement.id = snapshot.key;
    messageElement.classList.add("message");

    // Create a new div element for the username and the image
    var messageContentElement = document.createElement("div");
    messageContentElement.classList.add("message-content");

    // Create a link element for each URL in the message text
    var messageText = message.text;
    var messageTextWithLinks = messageText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

    // Create a new element for the username
    var usernameElement = document.createElement("strong");
    usernameElement.innerText = message.username + ": ";

    // Append the username and the message text to the message content element
    messageContentElement.appendChild(usernameElement);
    messageContentElement.innerHTML += messageTextWithLinks;

    // If the message has a file URL, create an img element with the file URL as the src attribute
if (message.fileUrl) {
    var imageElement = document.createElement("img");
    imageElement.src = message.fileUrl;
    imageElement.width = 200;
    imageElement.height = 200;
    //give class name to image element
    imageElement.classList.add("message");
    messageContentElement.appendChild(imageElement);

    // Add an event listener to the image element to show it once it's loaded
    imageElement.addEventListener("load", function() {
        imageElement.style.display = "block";
    });
}

    // Append the message content element to the message element
    messageElement.appendChild(messageContentElement);

    // Append the message element to the message container
    messageContainer.appendChild(messageElement);

    // Scroll to the bottom of the message container
    messageContainer.scrollTop = messageContainer.scrollHeight;

    // Animate the message element with a bubble animation
    setTimeout(function() {
        messageElement.classList.add("show");
    }, 0);
});

// Create a reference to the messages node
var messagesRef = database.ref("messages");

// Listen for changes to the messages node
messagesRef.on("child_removed", function(snapshot) {
    var message = document.getElementById(snapshot.key);
    if (message) {
        message.classList.add("hide");
        setTimeout(function() {
            messageContainer.removeChild(message);
            console.clear()
        }, 500);
    }
});
function submitUser() {
    var username = usernameInput.value;
    if (username.trim() !== "") {
        document.getElementById("user-container").style.display = "none";
        document.getElementById("chat-container").style.display = "block";
// Scroll to the bottom of the chat
        chatContainer.scrollTop = messageContainer.scrollHeight;
    }
    if(username.trim() == ""){
        alert("Please enter a username");
    }
}
// Get references to the HTML elements
var messageForm = document.getElementById("message-form");
var messageInput = document.getElementById("message-input");
var usernameInput = document.getElementById("username-input");
var fileInput = document.getElementById("file-input");

// Get references to the Firebase objects
var database = firebase.database();
var storage = firebase.storage();

// Handle form submission
var submitButton = document.getElementById("submitMessage");
submitButton.addEventListener("click", function(event) {
    
    //disable submitmessage
    submitButton.disabled = true;
    fileInput.disabled = true;
    messageInput.disabled = true;
    event.preventDefault();
    var messageText = messageInput.value;
    var username = usernameInput.value;
    var file = fileInput.files[0]; // Get the selected file
    if (file) {
        // Check if the file size is above the limit
        if (file.size > 15 * 1024 * 1024) {
            alert("File size is above the limit of 15MB");
            submitButton.disabled = false;
            fileInput.disabled = false;
            messageInput.disabled = false;
            return;
        }
        console.log("Uploading file...");
        var storageRef = storage.ref();
        var fileRef = storageRef.child(file.name);
        var uploadTask = fileRef.put(file);
        uploadTask.on("state_changed", function(snapshot) {
            // Log the upload progress to the console
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            var progressText = "Upload is " + progress.toFixed(2) + "% done";
            console.log(progressText);
            submitButton.innerHTML = progressText;
        }, function(error) {
            // Log any errors to the console
            console.error(error);
        }, function() {
            submitButton.disabled = false;
            fileInput.disabled = false;
            messageInput.disabled = false;
            //focus on message input
            messageInput.focus();
            // Once the upload is complete, get the download URL for the file
            uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                var message = {
                    username: username,
                    text: messageText,
                    fileUrl: downloadURL
                };
                database.ref("messages").push(message);
                messageInput.value = "";
                fileInput.value = ""; // Clear the file input
                chatContainer.scrollTop = messageContainer.scrollHeight;
                submitButton.disabled = false;
                submitButton.innerHTML = "Send";
            });
        });
    } else if (messageText.trim() !== "" && username.trim() !== "") {
        // If no file was selected but there is a message, push the message object to the database
        var message = {
            username: username,
            text: messageText,
            fileUrl: "" // Set the file URL to an empty string by default
        };
        database.ref("messages").push(message);
        messageInput.value = "";
        fileInput.value = ""; // Clear the file input
        //scroll to the bottom of the chat
        chatContainer.scrollTop = messageContainer.scrollHeight;
        submitButton.disabled = false;
        fileInput.disabled = false;
        messageInput.disabled = false;
        messageInput.focus();
    }
    if(messageText.trim() == "" && !file){
        submitButton.disabled = false;
        fileInput.disabled = false;
        messageInput.disabled = false;
        messageInput.focus();
    }
});
</script> 
</html>
