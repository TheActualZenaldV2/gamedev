<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe Multiplayer</title>
</head>
<body>
  <h1 id="title">Tic Tac Toe Multiplayer</h1>
  <div id="game-over" style="display: none;">
    <h1>Game Over</h1>
    <p id="disc">Your opponent has disconnected.</p>
    
  </div>
  <div id="spinnerText"> <h3>Loading...</h3></div>
    <div id="spinner"> </div>

  <div id="game" style="display: none">
    <span id="spectator"></span>
    <h3> <span id="currentPlayer"></span></h3>
  <div id="board-container"></div>
  <div id="buttons">
    <button onclick="createGameRoom()">Create Game Room</button>
    <input type="text" id="game-code" placeholder="Enter Game Code">
    <button onclick="joinGameRoom(document.getElementById('game-code').value)">Join Game Room</button>
    <button onclick="{
        location.reload();
        //clear the database
        gameRoomRef.remove();
        }">Restart Game</button>
  </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>  
</body>

  <style>
  /* import poppins font */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
  body {
  background-color: #1e1e1e;
  color: #d4d4d4;
  font: 16px Poppins, sans-serif;
  text-align: center;
}

#board-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  width: 300px;
  height: 300px;
  margin: 0 auto;
  font-family: "Times New Roman", Times, serif;
}

.cell {
  border: 1px solid #d4d4d4;
  font-size: 72px;
  text-align: center;
  line-height: 100px;
  cursor: pointer;
  height: 100px;
  width: 100px;
  color: #d4d4d4;
  font-family: "Times New Roman", Times, serif;

}

.cell:hover {
  background-color: #333333;
}

.row:after {
  content: "";
  display: table;
  clear: both;
}

#status {
  text-align: center;
  margin-top: 20px;
  font-size: 24px;
  color: #d4d4d4;
}

#buttons {
  text-align: center;
  margin-top: 20px;
}

button {
  font-size: 16px;
  padding: 10px 20px;
  margin: 0 10px;
  border: none;
  border-radius: 5px;
  background-color: #333333;
  color: #d4d4d4;
  cursor: pointer;
}

button:hover {
  background-color: #444444;
}

#spinnerText {
  margin-top: 20px;
  font-size: 24px;
  font-weight: bold;
  text-align: center;
}
#spinner {
  margin-top: 20px;
  text-align: center;
  display: inline-block;
  width: 50px;
  height: 50px;
  border: 5px solid rgba(0, 0, 0, 0.1);
  border-left-color: #7983ff;
  border-radius: 50%;
  animation: spin 1s ease-in-out infinite;
  background-color: #2f2f2f;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
  </style>

  <script>
 // Initialize Firebase
 const firebaseConfig = {
  apiKey: "AIzaSyAqBL7ia_zvhVCbHrAzBVeao0Sr4UKo3rQ",
  authDomain: "tic-tac-toe-ffc4d.firebaseapp.com",
  projectId: "tic-tac-toe-ffc4d",
  storageBucket: "tic-tac-toe-ffc4d.appspot.com",
  messagingSenderId: "885851412650",
  appId: "1:885851412650:web:06ff28330eb7e5f2c218d3",
  measurementId: "G-P790SXJBEE"
};
firebase.initializeApp(firebaseConfig);

// Get a reference to the game room in the database
var gameRoomRef = firebase.database().ref("gameRoom");

// Initialize game variables
var player = "X";
var opponent = "O";
var gameOver = false;
let turn;

// Set up the game board
var gameBoard = [
  ["", "", ""],
  ["", "", ""],
  ["", "", ""]
];






let currentPlayer;
console.log("It's " + player + "'s turn");

firebase.database().ref("gameRoom/currentPlayer").on("value", function(snapshot) {
  currentPlayer = snapshot.val();
  //if empty, set to X
  if (!currentPlayer) {
    currentPlayer = "X";
    firebase.database().ref("gameBoard/currentPlayer").update({ currentPlayer: currentPlayer });
  }
 
});

function handleMove(row, col) {
  if (gameBoard[row][col] || gameOver) {
    return;
  }

  gameBoard[row][col] = currentPlayer;

  renderBoard();

  function checkTie() {
    for (var i = 0; i < gameBoard.length; i++) {
      for (var j = 0; j < gameBoard[i].length; j++) {
        if (!gameBoard[i][j]) {
          return false;
        }
      }
    }
    return true;
  }

  // Check for a win or tie
  if (checkWin(currentPlayer)) {
    gameOver = true;
    gameRoomRef.update({ gameOver: true });
    //show game over
    document.getElementById("game-over").style.display = "block";
document.getElementById("disc").innerHTML = "Game Over, " + (currentPlayer === playerLetter ? "You win!" : "You Lose!");
    document.getElementById("game").style.display = "none";
    document.getElementById("title").style.display = "none";
    
  } else if (checkTie()) {
    gameOver = true;
    gameRoomRef.update({ gameOver: true });
    //show game over
    document.getElementById("game-over").style.display = "block";
    document.getElementById("disc").innerHTML = "Game Over, Tie game!";
    document.getElementById("game").style.display = "none";
    document.getElementById("title").style.display = "none";
  } else {
    // Switch players
    currentPlayer = currentPlayer === "X" ? "O" : "X";

    // Update the database with the new state of the game
    gameRoomRef.update({
       gameBoard: gameBoard,
       currentPlayer: currentPlayer
    
    });

  }
  
}
// Function to check for a win
function checkWin(player) {
  // Check rows
  for (var i = 0; i < gameBoard.length; i++) {
    if (gameBoard[i][0] === player && gameBoard[i][1] === player && gameBoard[i][2] === player) {
      return true;
    }
  }

  // Check columns
  for (var j = 0; j < gameBoard[0].length; j++) {
    if (gameBoard[0][j] === player && gameBoard[1][j] === player && gameBoard[2][j] === player) {
      return true;
    }
  }

  // Check diagonals
  if (gameBoard[0][0] === player && gameBoard[1][1] === player && gameBoard[2][2] === player) {
    return true;
  }
  if (gameBoard[0][2] === player && gameBoard[1][1] === player && gameBoard[2][0] === player) {
    return true;
  }

  // No win found
  return false;
}

//check if firebase says game is over
firebase.database().ref("gameRoom/gameOver").on("value", function(snapshot) {
  gameOver = snapshot.val();
  if (gameOver) {
    //show game over
    document.getElementById("game-over").style.display = "block";
    document.getElementById("disc").innerHTML = "Game Over, " + (currentPlayer === playerLetter ? "You win!" : "You Lose!");
    document.getElementById("game").style.display = "none";
    document.getElementById("title").style.display = "none";
  }
});

// Create a new game room in the Firebase Realtime Database
function createGameRoom() {
  gameRoomRef.set({
    gameBoard: gameBoard,
    player: player,
    opponent: opponent,
    gameOver: gameOver
  });
}

// Join an existing game room in the Firebase Realtime Database
function joinGameRoom(gameCode) {
  gameRoomRef = firebase.database().ref("gameRoom/" + gameCode);
}



// Initialize player number
let playerNumber;
let playerLetter;


// Limit the number of connections to 2
firebase.database().ref(".info/connected").on("value", (snapshot) => {
  if (snapshot.val() === true) {
    const connectionRef = firebase.database().ref("connections").push(true);
    connectionRef.onDisconnect().remove();

    firebase.database().ref("connections").once("value", (snapshot) => {
      const numConnections = snapshot.numChildren();
      if (numConnections <= 2) {
        // Assign player number based on the number of connections
        firebase.database().ref("players").once("value", (snapshot) => {
          const playerNumbers = Object.keys(snapshot.val() || {});
          const availableNumbers = [1, 2].filter(num => !playerNumbers.includes(num.toString()));
          if (availableNumbers.length > 0) {
            playerNumber = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
            //convert number to X or O
            playerLetter = playerNumber === 1 ? "X" : "O";
            console.log(`Player ${playerLetter} connected`);
            
            const spinner = document.getElementById("spinner");
            setTimeout(() => {
              spinner.style.display = "none";
              document.getElementById("game").style.display = "block";
              document.getElementById("spinnerText").style.display = "none";
            }, 500);

            // Store player number in Firebase
            firebase.database().ref(`players/${playerNumber}`).set(true);

            // Clear the board when a player disconnects
            const playerRef = firebase.database().ref(`players/${playerNumber}`);
            playerRef.onDisconnect().remove();

    
          } else {
            console.log("Both player numbers are already taken");
            playerNumber = null;
          }
        });
      } 
      //if there are more than 2 players
      else {
        console.log("Too many connections, you are now a spectator.");
        playerNumber = null;
        document.getElementById("spectator").innerHTML = "You are now a spectator.";
        //the user is now a spectator
        spectator = true;
        setTimeout(() => {
              spinner.style.display = "none";
              document.getElementById("game").style.display = "block";
              document.getElementById("spinnerText").style.display = "none";

            }, 500);
      }
    });
  }
});
function renderBoard() {
  var boardContainer = document.getElementById("board-container");
  boardContainer.innerHTML = "";

  for (var i = 0; i < gameBoard.length; i++) {
    for (var j = 0; j < gameBoard[i].length; j++) {
      var cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.row = i;
      cell.dataset.col = j;
      cell.textContent = gameBoard[i][j] || " ";


      cell.addEventListener("click", function() {
         // Check if the user is a player
  if (playerNumber === null) {
    console.log("You are spectating");
    return;
  }
  if (playerLetter !== currentPlayer) {
  console.log("It's not your turn");
  return;
}
        handleMove(this.dataset.row, this.dataset.col);
      });


      boardContainer.appendChild(cell);
    }
  }
}
firebase.database().ref("gameOver").onDisconnect().set(false);
//clear board on disconnect
firebase.database().ref("gameBoard").onDisconnect().set([
  ["", "", ""],
  ["", "", ""],
  ["", "", ""]
]);
//clear all data on disconnect
firebase.database().ref("gameRoom").onDisconnect().set({});


// Listen for changes to the players object in Firebase
firebase.database().ref("players").on("value", (snapshot) => {
  const numPlayers = snapshot.numChildren();
  if (numPlayers === 2) {
    // Both players exist, start watching for player disconnection
    firebase.database().ref("connections").on("value", (snapshot) => {
      const playerNumbers = Object.keys(snapshot.val() || {});
      if (playerNumbers.length === 2) {
        // Both players are still connected
      } else if (playerNumbers.length === 1) {
        // One player has disconnected, call the handleDisconnect function
        handleDisconnect();
      }
    });
  }
});


firebase.database().ref("gameOver").onDisconnect().set(false);



timer = 0;
setInterval(() => {
  timer++;
}, 1);
// Function to handle player disconnection
function handleDisconnect() {
  

  if(timer > 1000){
  
  //game over screen
  document.getElementById("game-over").style.display = "block";
  document.getElementById("game").style.display = "none";
  setTimeout(() => {
      location.reload();
    }, 3000);
  }
}

// Listen for changes to the game state in the Firebase Realtime Database
gameRoomRef.on("value", function(snapshot) {
  var gameState = snapshot.val();

  if (gameState) {
    // Update the game board
    gameBoard = gameState.gameBoard;

    // Update the game variables
    player = gameState.player;
    opponent = gameState.opponent;
    gameOver = gameState.gameOver;
    renderBoard();

  }
});

const turnElement = document.getElementById("currentPlayer");

firebase.database().ref("gameRoom/currentPlayer").on("value", function(snapshot) {
  var currentPlayer = snapshot.val();

  if (currentPlayer === playerLetter) {
    turnElement.textContent = "Your turn";
  } else if (currentPlayer) {
    turnElement.textContent = `Player ${currentPlayer}'s turn`;
    //add event listener
  } else {
    turnElement.textContent = "Waiting for players...";
    
  }
});


firebase.database().ref("connections").on("value", function(snapshot) {
  var numConnections = snapshot.numChildren();

  if (numConnections >= 2) {
    if(currentPlayer === playerLetter){
    turnElement.textContent = "Your turn";
    }
  } 
  if (numConnections >= 2 && currentPlayer !== playerLetter) {
    turnElement.textContent = `Player ${currentPlayer}'s turn`;
  }
});
renderBoard();
  </script>
</html>
